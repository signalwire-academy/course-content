---
layout: default
title: "Lab 2.5: Contexts and Workflows"
parent: "Level 2: Intermediate"
nav_order: 25
---
<p style="background: #dff0d8; border: 1px solid #3c763d; border-radius: 4px; padding: 15px; margin: 20px 0;">
<strong>ðŸŽ“ Ready to start this lab?</strong><br>
<a href="https://classroom.github.com/a/vvaT8z9y" target="_blank"><strong>Accept this assignment on GitHub Classroom</strong></a> to get your own repository.
</p>


**Duration:** 75 minutes
**Prerequisites:** Module 2.5 completed
**SDK Version:** signalwire-agents >= 1.0.11

## Objectives

- Build multi-step workflows with contexts
- Implement context transitions
- Handle workflow completion

## Setup

Create a new file `lab2_5_contexts.py`.

## Scenario

Build a pizza ordering agent with three contexts:

1. **Greeting** - Welcome and menu info
2. **Ordering** - Collect pizza order
3. **Checkout** - Confirm and complete

---

## Part 1: Define Contexts (25 min)

### Task

Create the three contexts with appropriate steps.

### Starter Code

```python
#!/usr/bin/env python3
"""Lab 2.5: Multi-context pizza ordering."""

from signalwire_agents import AgentBase, SwaigFunctionResult


class PizzaAgent(AgentBase):
    MENU = {
        "margherita": 12.99,
        "pepperoni": 14.99,
        "veggie": 13.99,
        "meat lovers": 16.99
    }

    SIZES = {
        "small": 0,
        "medium": 2,
        "large": 4
    }

    def __init__(self):
        super().__init__(name="pizza-agent")

        self.prompt_add_section(
            "Role",
            "You are a pizza ordering assistant for Pizza Palace."
        )

        self.add_language("English", "en-US", "rime.spore")

        self._setup_contexts()
        self._setup_functions()

    def _setup_contexts(self):
        # TODO: Create greeting, ordering, and checkout contexts
        pass

    def _setup_functions(self):
        # TODO: Create functions for each context
        pass


if __name__ == "__main__":
    agent = PizzaAgent()
    agent.run()
```

---

## Part 2: Greeting Context (15 min)

### Task

Create the greeting context with menu information.

### Expected Implementation

```python
def _setup_contexts(self):
    contexts = self.define_contexts()

    # Greeting context
    greeting = contexts.add_context("greeting")
    greeting.add_step("welcome") \
        .set_text("Welcome to Pizza Palace! Would you like to hear our menu "
                  "or start ordering?") \
        .set_step_criteria("Customer wants to order or hear menu") \
        .set_functions(["get_menu", "start_order"]) \
        .set_valid_contexts(["ordering"])
```

### Greeting Functions

```python
@self.tool(description="Get the pizza menu")
def get_menu(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    menu_items = [f"{name.title()}: ${price}" for name, price in self.MENU.items()]
    return SwaigFunctionResult(
        "Our pizzas are: " + ", ".join(menu_items) + ". "
        "Sizes are small, medium, or large."
    )

@self.tool(description="Start a new pizza order")
def start_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    return (
        SwaigFunctionResult("Great! What pizza would you like?")
        .swml_change_context("ordering")
        .set_metadata({"order_started": True, "items": []})
    )
```

---

## Part 3: Ordering Context (20 min)

### Task

Create the ordering context for collecting pizza details.

### Expected Implementation

```python
    # Ordering context (continuing from _setup_contexts)
    ordering = contexts.add_context("ordering")
    ordering.add_step("take_order") \
        .set_text("What pizza would you like to order?") \
        .set_step_criteria("Customer has specified pizza type and size") \
        .set_functions(["add_pizza", "finish_order", "get_menu"]) \
        .set_valid_contexts(["checkout"])
```

### Ordering Functions

```python
@self.tool(
    description="Add a pizza to the order",
    parameters={
        "type": "object",
        "properties": {
            "pizza_type": {
                "type": "string",
                "enum": list(self.MENU.keys())
            },
            "size": {
                "type": "string",
                "enum": list(self.SIZES.keys())
            }
        },
        "required": ["pizza_type", "size"]
    }
)
def add_pizza(
    args: dict,
    raw_data: dict = None
) -> SwaigFunctionResult:
    pizza_type = args.get("pizza_type", "")
    size = args.get("size", "")
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    items = global_data.get("items", [])

    base_price = self.MENU.get(pizza_type, 0)
    size_upcharge = self.SIZES.get(size, 0)
    price = base_price + size_upcharge

    items.append({
        "type": pizza_type,
        "size": size,
        "price": price
    })

    return (
        SwaigFunctionResult(
            f"Added {size} {pizza_type} pizza (${price:.2f}). "
            "Would you like anything else?"
        )
        .set_metadata({"items": items})
    )

@self.tool(description="Finish ordering and proceed to checkout")
def finish_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    items = global_data.get("items", [])

    if not items:
        return SwaigFunctionResult(
            "Your cart is empty. What pizza would you like?"
        )

    total = sum(item["price"] for item in items)

    return (
        SwaigFunctionResult(
            f"Your total is ${total:.2f}. Ready to checkout?"
        )
        .swml_change_context("checkout")
        .set_metadata({"total": total})
    )
```

---

## Part 4: Checkout Context (15 min)

### Task

Create the checkout context for order completion.

### Expected Implementation

```python
    # Checkout context (continuing from _setup_contexts)
    checkout = contexts.add_context("checkout")
    checkout.add_step("confirm") \
        .set_text("Please confirm your order.") \
        .set_step_criteria("Customer has confirmed or cancelled order") \
        .set_functions(["confirm_order", "cancel_order", "add_more"]) \
        .set_valid_contexts(["greeting", "ordering"])
```

### Checkout Functions

```python
@self.tool(description="Confirm and place the order")
def confirm_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    total = global_data.get("total", 0)
    items = global_data.get("items", [])

    order_summary = ", ".join(
        f"{i['size']} {i['type']}" for i in items
    )

    return (
        SwaigFunctionResult(
            f"Order confirmed! {order_summary}. "
            f"Total: ${total:.2f}. Ready in 20 minutes. Thank you!"
        )
        .set_metadata({"order_confirmed": True})
    )

@self.tool(description="Cancel the order")
def cancel_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    return (
        SwaigFunctionResult("Order cancelled. Come back anytime!")
        .set_metadata({"items": [], "total": 0})
        .swml_change_context("greeting")
    )

@self.tool(description="Go back to add more items")
def add_more(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    return (
        SwaigFunctionResult("Sure! What else would you like?")
        .swml_change_context("ordering")
    )
```

---

## Complete Solution

```python
#!/usr/bin/env python3
"""Lab 2.5: Multi-context pizza ordering."""

from signalwire_agents import AgentBase, SwaigFunctionResult


class PizzaAgent(AgentBase):
    MENU = {
        "margherita": 12.99,
        "pepperoni": 14.99,
        "veggie": 13.99,
        "meat lovers": 16.99
    }

    SIZES = {
        "small": 0,
        "medium": 2,
        "large": 4
    }

    def __init__(self):
        super().__init__(name="pizza-agent")

        self.prompt_add_section(
            "Role",
            "You are a pizza ordering assistant for Pizza Palace."
        )

        self.add_language("English", "en-US", "rime.spore")

        self._setup_contexts()
        self._setup_functions()

    def _setup_contexts(self):
        contexts = self.define_contexts()

        # Greeting context
        greeting = contexts.add_context("greeting")
        greeting.add_step("welcome") \
            .set_text("Welcome to Pizza Palace! Would you like to hear our menu?") \
            .set_step_criteria("Customer wants to order or hear menu") \
            .set_functions(["get_menu", "start_order"]) \
            .set_valid_contexts(["ordering"])

        # Ordering context
        ordering = contexts.add_context("ordering")
        ordering.add_step("take_order") \
            .set_text("What pizza would you like?") \
            .set_step_criteria("Customer has ordered or wants to checkout") \
            .set_functions(["add_pizza", "finish_order", "get_menu"]) \
            .set_valid_contexts(["checkout"])

        # Checkout context
        checkout = contexts.add_context("checkout")
        checkout.add_step("confirm") \
            .set_text("Please confirm your order.") \
            .set_step_criteria("Customer has confirmed or cancelled") \
            .set_functions(["confirm_order", "cancel_order", "add_more"]) \
            .set_valid_contexts(["greeting", "ordering"])

    def _setup_functions(self):
        @self.tool(description="Get the menu")
        def get_menu(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            items = [f"{n.title()}: ${p}" for n, p in self.MENU.items()]
            return SwaigFunctionResult("Our pizzas: " + ", ".join(items))

        @self.tool(description="Start ordering")
        def start_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            return (
                SwaigFunctionResult("Great! What pizza would you like?")
                .swml_change_context("ordering")
                .set_metadata({"items": []})
            )

        @self.tool(
            description="Add pizza to order",
            parameters={
                "type": "object",
                "properties": {
                    "pizza_type": {"type": "string", "enum": list(self.MENU.keys())},
                    "size": {"type": "string", "enum": list(self.SIZES.keys())}
                },
                "required": ["pizza_type", "size"]
            }
        )
        def add_pizza(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            pizza_type = args.get("pizza_type", "")
            size = args.get("size", "")
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            items = global_data.get("items", [])
            price = self.MENU[pizza_type] + self.SIZES[size]
            items.append({"type": pizza_type, "size": size, "price": price})

            return (
                SwaigFunctionResult(f"Added {size} {pizza_type} (${price:.2f}). More?")
                .set_metadata({"items": items})
            )

        @self.tool(description="Finish and checkout")
        def finish_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            items = global_data.get("items", [])
            if not items:
                return SwaigFunctionResult("Cart empty. What would you like?")
            total = sum(i["price"] for i in items)
            return (
                SwaigFunctionResult(f"Total: ${total:.2f}. Confirm?")
                .swml_change_context("checkout")
                .set_metadata({"total": total})
            )

        @self.tool(description="Confirm order")
        def confirm_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            total = global_data.get("total", 0)
            return (
                SwaigFunctionResult(f"Confirmed! ${total:.2f}. Ready in 20 min!")
                .set_metadata({"confirmed": True})
            )

        @self.tool(description="Cancel order")
        def cancel_order(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            return (
                SwaigFunctionResult("Cancelled. Come back anytime!")
                .swml_change_context("greeting")
                .set_metadata({"items": []})
            )

        @self.tool(description="Add more items")
        def add_more(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            return (
                SwaigFunctionResult("What else?")
                .swml_change_context("ordering")
            )


if __name__ == "__main__":
    agent = PizzaAgent()
    agent.run()
```

---

## Testing

```bash
# Test agent
swaig-test lab2_5_contexts.py --dump-swml

# Verify contexts in SWML
swaig-test lab2_5_contexts.py --dump-swml | grep -A10 "contexts"

# Test workflow functions
swaig-test lab2_5_contexts.py --exec start_order
swaig-test lab2_5_contexts.py --exec add_pizza \
  --pizza_type "pepperoni" \
  --size "large"
```

---

## Validation Checklist

- [ ] Three contexts defined (greeting, ordering, checkout)
- [ ] Context transitions work correctly
- [ ] State persists across context switches
- [ ] Order total calculates correctly
- [ ] Can cancel and return to greeting

---

## Submission

Upload your completed `lab2_5_contexts.py` file.
