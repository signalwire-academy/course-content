---
layout: default
title: "Lab 2.6: State Management"
parent: "Level 2: Intermediate"
nav_order: 26
---
<p style="background: #dff0d8; border: 1px solid #3c763d; border-radius: 4px; padding: 15px; margin: 20px 0;">
<strong>ðŸŽ“ Ready to start this lab?</strong><br>
<a href="https://classroom.github.com/a/Vz7O-ARS" target="_blank"><strong>Accept this assignment on GitHub Classroom</strong></a> to get your own repository.
</p>


**Duration:** 45 minutes
**Prerequisites:** Module 2.6 completed

## Objectives

- Implement global data for shared configuration
- Use call metadata for per-call state
- Pass state between function calls

## Setup

Create a new file `lab2_6_state.py`.

## Scenario

Build a customer service agent that:

1. Identifies customers by phone
2. Tracks conversation topics
3. Maintains a help ticket throughout the call

---

## Part 1: Global Data (15 min)

### Task

Set up global data for company information and service hours.

### Starter Code

```python
#!/usr/bin/env python3
"""Lab 2.6: State management."""

from datetime import datetime
from signalwire_agents import AgentBase, SwaigFunctionResult


class ServiceAgent(AgentBase):
    # Simulated customer database
    CUSTOMERS = {
        "+15551234567": {"id": "C001", "name": "John Smith", "tier": "gold"},
        "+15559876543": {"id": "C002", "name": "Jane Doe", "tier": "silver"},
    }

    def __init__(self):
        super().__init__(name="service-agent")

        self.prompt_add_section(
            "Role",
            "You are a customer service agent for TechCorp. "
            "Help customers with inquiries and track issues."
        )

        self.add_language("English", "en-US", "rime.spore")

        self._setup_global_data()
        self._setup_functions()

    def _setup_global_data(self):
        # TODO: Set up global data
        pass

    def _setup_functions(self):
        # TODO: Set up functions
        pass


if __name__ == "__main__":
    agent = ServiceAgent()
    agent.run()
```

### Expected Implementation

```python
def _setup_global_data(self):
    hour = datetime.now().hour

    self.set_global_data({
        "company_name": "TechCorp",
        "support_email": "support@techcorp.com",
        "support_phone": "1-800-TECH",
        "business_hours": "9 AM to 6 PM EST",
        "is_business_hours": 9 <= hour < 18,
        "greeting": "Good morning" if hour < 12 else "Good afternoon"
    })
```

---

## Part 2: Customer Identification (15 min)

### Task

Create a function that identifies customers and stores their info in metadata.

### Expected Implementation

```python
@self.tool(
    description="Identify customer by phone number",
    parameters={
        "type": "object",
        "properties": {
            "phone": {
                "type": "string",
                "description": "Customer phone number"
            }
        },
        "required": ["phone"]
    }
)
def identify_customer(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    phone = args.get("phone", "")
    customer = self.CUSTOMERS.get(phone)

    if customer:
        global_data = self.get_global_data()
        greeting = global_data.get("greeting", "Hello")

        return (
            SwaigFunctionResult(
                f"{greeting}, {customer['name']}! "
                f"I see you're a {customer['tier']} member. How can I help?"
            )
            .add_action("set_meta_data", {
                "customer_id": customer["id"],
                "customer_name": customer["name"],
                "customer_tier": customer["tier"],
                "identified": True
            })
        )

    return SwaigFunctionResult(
        "I don't recognize that number. Could you provide your account ID?"
    )
```

---

## Part 3: Ticket Tracking (15 min)

### Task

Create functions to create and update support tickets using metadata.

### Expected Implementation

```python
@self.tool(
    description="Create a support ticket",
    parameters={
        "type": "object",
        "properties": {
            "issue": {
                "type": "string",
                "description": "Description of the issue"
            }
        },
        "required": ["issue"]
    }
)
def create_ticket(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    issue = args.get("issue", "")
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    customer_id = global_data.get("customer_id", "UNKNOWN")
    customer_name = global_data.get("customer_name", "Customer")

    # Generate ticket ID
    ticket_id = f"TKT-{datetime.now().strftime('%Y%m%d%H%M%S')}"

    return (
        SwaigFunctionResult(
            f"I've created ticket {ticket_id} for you, {customer_name}. "
            "Is there anything else about this issue?"
        )
        .add_action("set_meta_data", {
            "ticket_id": ticket_id,
            "ticket_issue": issue,
            "ticket_notes": []
        })
    )

@self.tool(
    description="Add a note to the current ticket",
    parameters={
        "type": "object",
        "properties": {
            "note": {
                "type": "string",
                "description": "Additional information"
            }
        },
        "required": ["note"]
    }
)
def add_ticket_note(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    note = args.get("note", "")
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    ticket_id = global_data.get("ticket_id")
    notes = global_data.get("ticket_notes", [])

    if not ticket_id:
        return SwaigFunctionResult(
            "No ticket found. Would you like me to create one?"
        )

    notes.append({
        "time": datetime.now().isoformat(),
        "content": note
    })

    return (
        SwaigFunctionResult(f"Added note to ticket {ticket_id}.")
        .add_action("set_meta_data", {"ticket_notes": notes})
    )

@self.tool(description="Get ticket summary")
def get_ticket_summary(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
    raw_data = raw_data or {}
    global_data = raw_data.get("global_data", {})
    ticket_id = global_data.get("ticket_id")
    issue = global_data.get("ticket_issue", "No issue recorded")
    notes = global_data.get("ticket_notes", [])

    if not ticket_id:
        return SwaigFunctionResult("No active ticket.")

    summary = f"Ticket {ticket_id}: {issue}. {len(notes)} notes added."
    return SwaigFunctionResult(summary)
```

---

## Complete Solution

```python
#!/usr/bin/env python3
"""Lab 2.6: State management."""

from datetime import datetime
from signalwire_agents import AgentBase, SwaigFunctionResult


class ServiceAgent(AgentBase):
    CUSTOMERS = {
        "+15551234567": {"id": "C001", "name": "John Smith", "tier": "gold"},
        "+15559876543": {"id": "C002", "name": "Jane Doe", "tier": "silver"},
    }

    def __init__(self):
        super().__init__(name="service-agent")

        self.prompt_add_section(
            "Role",
            "You are a customer service agent for TechCorp."
        )

        self.add_language("English", "en-US", "rime.spore")

        self._setup_global_data()
        self._setup_functions()

    def _setup_global_data(self):
        hour = datetime.now().hour
        self.set_global_data({
            "company_name": "TechCorp",
            "support_email": "support@techcorp.com",
            "is_business_hours": 9 <= hour < 18,
            "greeting": "Good morning" if hour < 12 else "Good afternoon"
        })

    def _setup_functions(self):
        @self.tool(description="Identify customer", parameters={
            "type": "object",
            "properties": {"phone": {"type": "string"}},
            "required": ["phone"]
        })
        def identify_customer(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            phone = args.get("phone", "")
            customer = self.CUSTOMERS.get(phone)
            if customer:
                greeting = self.get_global_data().get("greeting", "Hello")
                return (
                    SwaigFunctionResult(f"{greeting}, {customer['name']}!")
                    .add_action("set_meta_data", {
                        "customer_id": customer["id"],
                        "customer_name": customer["name"],
                        "customer_tier": customer["tier"]
                    })
                )
            return SwaigFunctionResult("Number not recognized.")

        @self.tool(description="Create ticket", parameters={
            "type": "object",
            "properties": {"issue": {"type": "string"}},
            "required": ["issue"]
        })
        def create_ticket(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            issue = args.get("issue", "")
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            name = global_data.get("customer_name", "Customer")
            ticket_id = f"TKT-{datetime.now().strftime('%Y%m%d%H%M%S')}"
            return (
                SwaigFunctionResult(f"Created {ticket_id}, {name}.")
                .add_action("set_meta_data", {
                    "ticket_id": ticket_id,
                    "ticket_issue": issue,
                    "ticket_notes": []
                })
            )

        @self.tool(description="Add ticket note", parameters={
            "type": "object",
            "properties": {"note": {"type": "string"}},
            "required": ["note"]
        })
        def add_ticket_note(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            note = args.get("note", "")
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            ticket_id = global_data.get("ticket_id")
            notes = global_data.get("ticket_notes", [])
            if not ticket_id:
                return SwaigFunctionResult("No active ticket.")
            notes.append({"time": datetime.now().isoformat(), "content": note})
            return (
                SwaigFunctionResult(f"Note added to {ticket_id}.")
                .add_action("set_meta_data", {"ticket_notes": notes})
            )

        @self.tool(description="Get ticket summary")
        def get_ticket_summary(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            ticket_id = global_data.get("ticket_id")
            issue = global_data.get("ticket_issue", "None")
            notes = global_data.get("ticket_notes", [])
            if not ticket_id:
                return SwaigFunctionResult("No active ticket.")
            return SwaigFunctionResult(
                f"Ticket {ticket_id}: {issue}. {len(notes)} notes."
            )


if __name__ == "__main__":
    agent = ServiceAgent()
    agent.run()
```

---

## Testing

```bash
# Test agent
swaig-test lab2_6_state.py --dump-swml

# Verify global data in SWML
swaig-test lab2_6_state.py --dump-swml | grep -A5 "global_data"

# Test identify customer
swaig-test lab2_6_state.py --exec identify_customer \
  --phone "+15551234567"

# Test create ticket
swaig-test lab2_6_state.py --exec create_ticket \
  --issue "Cannot login to account"
```

---

## Validation Checklist

- [ ] Global data contains company info
- [ ] Customer identification stores metadata
- [ ] Ticket creation uses customer metadata
- [ ] Notes accumulate in metadata
- [ ] Summary reads from metadata correctly

---

## Submission

Upload your completed `lab2_6_state.py` file.
