---
layout: default
title: "Lab 2.9: Multi-Agent Architecture"
parent: "Level 2: Intermediate"
nav_order: 29
---
<p style="background: #dff0d8; border: 1px solid #3c763d; border-radius: 4px; padding: 15px; margin: 20px 0;">
<strong>ðŸŽ“ Ready to start this lab?</strong><br>
<a href="https://classroom.github.com/a/VAnSFL2W" target="_blank"><strong>Accept this assignment on GitHub Classroom</strong></a> to get your own repository.
</p>


**Duration:** 75 minutes
**Prerequisites:** Module 2.9 completed

## Objectives

- Configure AgentServer with multiple agents
- Implement path-based routing
- Share state between agents

## Setup

Create a new file `lab2_9_multi_agent.py`.

## Scenario

Build a customer service system with:

1. General inquiry agent (/)
2. Sales agent (/sales)
3. Support agent (/support)

---

## Part 1: Create Individual Agents (30 min)

### Task

Define three specialized agent classes.

### Starter Code

```python
#!/usr/bin/env python3
"""Lab 2.9: Multi-agent architecture."""

from signalwire_agents import AgentBase, AgentServer, SwaigFunctionResult


class GeneralAgent(AgentBase):
    """General inquiry handler."""

    def __init__(self):
        super().__init__(name="general-agent", route="/")

        self.prompt_add_section(
            "Role",
            "You are the general inquiry agent. Help route callers "
            "or answer basic questions about the company."
        )

        self.prompt_add_section(
            "Routing",
            "For sales inquiries, direct to /sales. "
            "For technical support, direct to /support."
        )

        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        # TODO: Add functions
        pass


class SalesAgent(AgentBase):
    """Sales specialist."""

    def __init__(self):
        super().__init__(name="sales-agent", route="/sales")

        self.prompt_add_section(
            "Role",
            "You are a sales specialist. Help customers with "
            "product information, pricing, and purchases."
        )

        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        # TODO: Add functions
        pass


class SupportAgent(AgentBase):
    """Technical support."""

    def __init__(self):
        super().__init__(name="support-agent", route="/support")

        self.prompt_add_section(
            "Role",
            "You are technical support. Help customers troubleshoot "
            "issues and resolve problems."
        )

        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        # TODO: Add functions
        pass


if __name__ == "__main__":
    # TODO: Create server and register agents
    pass
```

---

## Part 2: Implement Agent Functions (25 min)

### General Agent Functions

```python
def _setup_functions(self):
    @self.tool(description="Get company information")
    def get_company_info(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        return SwaigFunctionResult(
            "We are TechCorp, providing innovative solutions since 2010. "
            "For sales, I can connect you to our sales team. "
            "For support, I can transfer you to technical support."
        )

    @self.tool(description="Get business hours")
    def get_hours(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        return SwaigFunctionResult(
            "We're open Monday to Friday, 9 AM to 6 PM Eastern. "
            "Our sales team is available during these hours, "
            "and support is available 8 AM to 8 PM."
        )
```

### Sales Agent Functions

```python
def _setup_functions(self):
    PRODUCTS = {
        "basic": {"price": 29.99, "features": ["Email support", "5 users"]},
        "pro": {"price": 79.99, "features": ["Priority support", "25 users", "API access"]},
        "enterprise": {"price": 199.99, "features": ["24/7 support", "Unlimited users", "Custom integration"]}
    }

    @self.tool(description="Get product pricing")
    def get_pricing(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        prices = [f"{name.title()}: ${info['price']}/month"
                  for name, info in PRODUCTS.items()]
        return SwaigFunctionResult(
            "Our plans: " + "; ".join(prices)
        )

    @self.tool(
        description="Get product details",
        parameters={
            "type": "object",
            "properties": {
                "product": {"type": "string", "enum": list(PRODUCTS.keys())}
            },
            "required": ["product"]
        }
    )
    def get_product_details(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        product = args.get("product", "")
        info = PRODUCTS.get(product)
        if not info:
            return SwaigFunctionResult("Unknown product.")
        features = ", ".join(info["features"])
        return SwaigFunctionResult(
            f"{product.title()} plan: ${info['price']}/month. "
            f"Includes: {features}"
        )

    @self.tool(
        description="Start a purchase",
        parameters={
            "type": "object",
            "properties": {
                "product": {"type": "string", "enum": list(PRODUCTS.keys())},
                "customer_email": {"type": "string"}
            },
            "required": ["product", "customer_email"]
        }
    )
    def start_purchase(
        args: dict,
        raw_data: dict = None
    ) -> SwaigFunctionResult:
        product = args.get("product", "")
        customer_email = args.get("customer_email", "")
        info = PRODUCTS.get(product)
        return (
            SwaigFunctionResult(
                f"Great choice! I'm setting up {product.title()} "
                f"for {customer_email}. You'll receive a confirmation email."
            )
            .add_action("set_meta_data", {
                "purchase_product": product,
                "purchase_email": customer_email,
                "purchase_initiated": True
            })
        )
```

### Support Agent Functions

```python
def _setup_functions(self):
    TROUBLESHOOTING = {
        "login": "Try resetting your password at account.techcorp.com/reset",
        "slow": "Clear your browser cache and try a different browser",
        "error": "Please note the error code and I'll look it up",
        "crash": "Update to the latest version from our downloads page"
    }

    @self.tool(description="Get common solutions")
    def get_common_issues(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        issues = list(TROUBLESHOOTING.keys())
        return SwaigFunctionResult(
            f"Common issues I can help with: {', '.join(issues)}. "
            "What issue are you experiencing?"
        )

    @self.tool(
        description="Troubleshoot an issue",
        parameters={
            "type": "object",
            "properties": {
                "issue_type": {"type": "string"}
            },
            "required": ["issue_type"]
        }
    )
    def troubleshoot(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        issue_type = args.get("issue_type", "")
        issue_lower = issue_type.lower()

        for key, solution in TROUBLESHOOTING.items():
            if key in issue_lower:
                return SwaigFunctionResult(
                    f"For {key} issues: {solution}. "
                    "Did that help resolve your issue?"
                )

        return SwaigFunctionResult(
            "I'll need more details. Can you describe the issue?"
        )

    @self.tool(
        description="Create support ticket",
        parameters={
            "type": "object",
            "properties": {
                "description": {"type": "string"},
                "priority": {"type": "string", "enum": ["low", "medium", "high"]}
            },
            "required": ["description"]
        }
    )
    def create_ticket(
        args: dict,
        raw_data: dict = None
    ) -> SwaigFunctionResult:
        description = args.get("description", "")
        priority = args.get("priority", "medium")
        import datetime
        ticket_id = f"TKT-{datetime.datetime.now().strftime('%Y%m%d%H%M%S')}"

        return (
            SwaigFunctionResult(
                f"Created ticket {ticket_id} with {priority} priority. "
                "Our team will contact you within 24 hours."
            )
            .add_action("set_meta_data", {
                "ticket_id": ticket_id,
                "ticket_description": description,
                "ticket_priority": priority
            })
        )
```

---

## Part 3: Configure AgentServer (20 min)

### Task

Set up the server with all agents.

### Expected Implementation

```python
if __name__ == "__main__":
    # Create server
    server = AgentServer(host="0.0.0.0", port=3000)

    # Register all agents
    server.register(GeneralAgent())
    server.register(SalesAgent())
    server.register(SupportAgent())

    # Run server
    server.run()
```

---

## Complete Solution

```python
#!/usr/bin/env python3
"""Lab 2.9: Multi-agent architecture."""

import datetime
from signalwire_agents import AgentBase, AgentServer, SwaigFunctionResult


class GeneralAgent(AgentBase):
    def __init__(self):
        super().__init__(name="general-agent", route="/")
        self.prompt_add_section("Role", "General inquiry handler for TechCorp.")
        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        @self.tool(description="Get company info")
        def get_company_info(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            return SwaigFunctionResult(
                "TechCorp provides software solutions. "
                "Sales at /sales, support at /support."
            )

        @self.tool(description="Get hours")
        def get_hours(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            return SwaigFunctionResult("Open M-F 9AM-6PM Eastern.")


class SalesAgent(AgentBase):
    PRODUCTS = {
        "basic": {"price": 29.99, "features": ["Email support", "5 users"]},
        "pro": {"price": 79.99, "features": ["Priority support", "25 users"]},
        "enterprise": {"price": 199.99, "features": ["24/7 support", "Unlimited"]}
    }

    def __init__(self):
        super().__init__(name="sales-agent", route="/sales")
        self.prompt_add_section("Role", "Sales specialist for TechCorp products.")
        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        @self.tool(description="Get pricing")
        def get_pricing(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            prices = [f"{k.title()}: ${v['price']}/mo" for k, v in self.PRODUCTS.items()]
            return SwaigFunctionResult("Plans: " + "; ".join(prices))

        @self.tool(description="Get product details", parameters={
            "type": "object",
            "properties": {"product": {"type": "string", "enum": list(self.PRODUCTS.keys())}},
            "required": ["product"]
        })
        def get_product_details(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            product = args.get("product", "")
            info = self.PRODUCTS.get(product)
            if not info:
                return SwaigFunctionResult("Unknown product.")
            return SwaigFunctionResult(
                f"{product.title()}: ${info['price']}/mo. {', '.join(info['features'])}"
            )


class SupportAgent(AgentBase):
    def __init__(self):
        super().__init__(name="support-agent", route="/support")
        self.prompt_add_section("Role", "Technical support for TechCorp.")
        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _setup_functions(self):
        @self.tool(description="Create ticket", parameters={
            "type": "object",
            "properties": {
                "description": {"type": "string"},
                "priority": {"type": "string", "enum": ["low", "medium", "high"]}
            },
            "required": ["description"]
        })
        def create_ticket(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            description = args.get("description", "")
            priority = args.get("priority", "medium")
            ticket_id = f"TKT-{datetime.datetime.now().strftime('%Y%m%d%H%M%S')}"
            return (
                SwaigFunctionResult(f"Created {ticket_id} ({priority} priority).")
                .add_action("set_meta_data", {"ticket_id": ticket_id})
            )


if __name__ == "__main__":
    server = AgentServer(host="0.0.0.0", port=3000)
    server.register(GeneralAgent())
    server.register(SalesAgent())
    server.register(SupportAgent())
    server.run()
```

---

## Testing

```bash
# Run the multi-agent server
python lab2_9_multi_agent.py &

# Test general agent
curl http://localhost:3000/

# Test sales agent
curl http://localhost:3000/sales

# Test support agent
curl http://localhost:3000/support

# Test with swaig-test
swaig-test lab2_9_multi_agent.py --agent-class GeneralAgent --list-tools
swaig-test lab2_9_multi_agent.py --agent-class SalesAgent --list-tools
swaig-test lab2_9_multi_agent.py --agent-class SupportAgent --list-tools
```

---

## Validation Checklist

- [ ] Three agents defined with unique routes
- [ ] Each agent has specialized functions
- [ ] AgentServer registers all agents
- [ ] Routes resolve correctly (/, /sales, /support)
- [ ] Each agent generates valid SWML

---

## Challenge Extension

Add a shared authentication function that all agents can use:

```python
# Create a mixin class
class AuthMixin:
    def add_auth_functions(self):
        @self.tool(description="Verify customer", parameters={
            "type": "object",
            "properties": {"customer_id": {"type": "string"}},
            "required": ["customer_id"]
        })
        def verify_customer(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            customer_id = args.get("customer_id", "")
            # Shared verification logic
            return (
                SwaigFunctionResult(f"Verified customer {customer_id}")
                .add_action("set_meta_data", {"verified": True, "customer_id": customer_id})
            )
```

---

## Submission

Upload your completed `lab2_9_multi_agent.py` file.
