---
layout: default
title: "Lab 3.1: Architecture Design Workshop"
parent: "Level 3: Advanced"
nav_order: 21
---
<p style="background: #dff0d8; border: 1px solid #3c763d; border-radius: 4px; padding: 15px; margin: 20px 0;">
<strong>ðŸŽ“ Ready to start this lab?</strong><br>
<a href="https://classroom.github.com/a/x7wIWuEm" target="_blank"><strong>Accept this assignment on GitHub Classroom</strong></a> to get your own repository.
</p>


**Duration:** 2 hours
**Prerequisites:** Module 3.1 completed

## Objectives

- Design a multi-agent architecture
- Document with Architecture Decision Records
- Identify and refactor anti-patterns
- Present and defend design decisions

## Scenario

You're architecting a voice AI system for "HealthFirst Insurance" that needs to handle:

- Member services (benefits, claims, ID cards)
- Provider services (eligibility, prior auth)
- General inquiries (hours, locations, contact info)

---

## Part 1: Architecture Design (45 min)

### Task

Design the system architecture addressing:

1. Agent organization (how many, what roles)
2. Routing strategy
3. State management
4. Security requirements (HIPAA)

### Deliverable

Create `architecture_design.md` with:

```markdown
# HealthFirst Voice AI Architecture

## Overview
[High-level description]

## System Diagram
[ASCII or description of component relationships]

## Agents

### Gateway Agent

- Route: /
- Purpose: [describe]
- Functions: [list]

### Member Services Agent

- Route: /member
- Purpose: [describe]
- Functions: [list]

### Provider Services Agent

- Route: /provider
- Purpose: [describe]
- Functions: [list]

## Data Flow
[How calls move through the system]

## State Management
[How state is shared/persisted]

## Security Considerations
[HIPAA compliance approach]
```

### Design Questions to Answer

1. Should member and provider services be separate agents?
2. How do you verify caller identity for PHI access?
3. Where does session state live?
4. How do you handle after-hours calls?

---

## Part 2: Architecture Decision Records (30 min)

### Task

Document three key decisions using ADR format.

### Template

```markdown
# ADR [NUMBER]: [TITLE]

## Status
[Proposed | Accepted | Deprecated | Superseded]

## Context
[What is the issue we're addressing?]

## Decision
[What did we decide to do?]

## Consequences
[What becomes easier or harder?]
```

### Required ADRs

**ADR 001: Agent Separation Strategy**

- Decide: One agent vs. multiple specialized agents
- Consider: Maintenance, security boundaries, prompt complexity

**ADR 002: Caller Verification Approach**

- Decide: How to verify identity for PHI access
- Consider: PIN, callback, multi-factor

**ADR 003: State Persistence**

- Decide: In-memory vs. Redis vs. Database
- Consider: Scalability, cost, complexity

### Example ADR

```markdown
# ADR 001: Multi-Agent Architecture

## Status
Accepted

## Context
HealthFirst needs to handle member services, provider services,
and general inquiries. We need to decide how to organize the agents.

## Decision
We will use a multi-agent architecture with:
- Gateway agent for routing and general inquiries
- Member services agent for member-specific functions
- Provider services agent for healthcare provider functions

## Consequences
### Positive

- Clear separation of concerns
- Teams can work independently on each agent
- Security boundaries between member and provider data
- Easier prompt management (focused contexts)

### Negative

- More complex deployment (3 agents vs 1)
- Need shared state solution for cross-agent data
- More endpoints to monitor
```

---

## Part 3: Anti-Pattern Identification (25 min)

### Task

Review the following code and identify anti-patterns. Document each issue and propose a fix.

### Code to Review

```python
# healthfirst_agent.py (CONTAINS ANTI-PATTERNS)

from signalwire_agents import AgentBase, SwaigFunctionResult
import requests

class HealthFirstAgent(AgentBase):
    def __init__(self):
        super().__init__(name="healthfirst")

        # REVIEW: Is this a good prompt structure?
        self.prompt_add_section(
            "Role",
            "You are an extremely professional, highly knowledgeable, and "
            "exceptionally customer-focused health insurance representative "
            "who works for HealthFirst Insurance Company, a leading provider "
            "of comprehensive health coverage solutions for individuals, "
            "families, and businesses across the nation since 1985..."
            # (continues for 500 more words)
        )

        # REVIEW: Hardcoded credentials?
        self.set_params({
            "swml_basic_auth_user": "healthfirst",
            "swml_basic_auth_password": "insurance123"
        })

        self.add_language("English", "en-US", "rime.spore")

    @AgentBase.tool(description="Get member benefits")
    def get_benefits(self, args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        member_id = args.get("member_id", "")
        # REVIEW: Error handling?
        response = requests.get(
            f"https://api.healthfirst.com/members/{member_id}/benefits"
        )
        return SwaigFunctionResult(str(response.json()))

    @AgentBase.tool(description="Look up claim")
    def get_claim(self, args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        claim_id = args.get("claim_id", "")
        # REVIEW: What if this takes 30 seconds?
        response = requests.get(
            f"https://api.healthfirst.com/claims/{claim_id}"
        )
        data = response.json()
        # REVIEW: Is this appropriate error handling?
        if "error" in data:
            return SwaigFunctionResult(f"Error: {data['error']}")
        return SwaigFunctionResult(f"Claim status: {data}")

    @AgentBase.tool(description="Submit prior auth")
    def submit_prior_auth(self, args: dict, raw_data: dict = None) -> SwaigFunctionResult:
        member_id = args.get("member_id", "")
        procedure_code = args.get("procedure_code", "")
        diagnosis_code = args.get("diagnosis_code", "")
        provider_npi = args.get("provider_npi", "")
        # REVIEW: No verification before PHI access?
        response = requests.post(
            "https://api.healthfirst.com/prior-auth",
            json={
                "member_id": member_id,
                "procedure": procedure_code,
                "diagnosis": diagnosis_code,
                "provider": provider_npi
            }
        )
        return SwaigFunctionResult(f"Prior auth submitted: {response.json()}")

    # ... 45 more functions for every possible operation
```

### Deliverable

Create `anti_patterns.md`:

```markdown
# Anti-Pattern Analysis

## Issue 1: [Name]
**Location:** [Line/Section]
**Problem:** [Description]
**Impact:** [What goes wrong]
**Solution:** [How to fix]

## Issue 2: ...
```

---

## Part 4: Refactored Implementation (20 min)

### Task

Implement the gateway agent with proper patterns.

### Deliverable: `gateway_agent.py`

```python
#!/usr/bin/env python3
"""HealthFirst Gateway Agent - Properly architected."""

import os
from signalwire_agents import AgentBase, SwaigFunctionResult


class GatewayAgent(AgentBase):
    DEPARTMENTS = {
        "member": {
            "route": "/member",
            "description": "Member services - benefits, claims, ID cards"
        },
        "provider": {
            "route": "/provider",
            "description": "Provider services - eligibility, prior authorization"
        }
    }

    def __init__(self):
        super().__init__(name="healthfirst-gateway", route="/")

        self._configure_auth()
        self._configure_prompts()
        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _configure_auth(self):
        """Configure authentication from environment."""
        user = os.getenv("AUTH_USER")
        password = os.getenv("AUTH_PASSWORD")

        if not user or not password:
            raise ValueError("AUTH_USER and AUTH_PASSWORD required")

        self.set_params({
            "swml_basic_auth_user": user,
            "swml_basic_auth_password": password
        })

    def _configure_prompts(self):
        """Set up focused, concise prompts."""
        self.prompt_add_section(
            "Role",
            "HealthFirst Insurance gateway. Route callers to the right department."
        )

        self.prompt_add_section(
            "Departments",
            bullets=[
                "Member services: benefits, claims, ID cards",
                "Provider services: eligibility, prior authorization"
            ]
        )

        self.prompt_add_section(
            "Hours",
            "Member: 8am-8pm. Provider: 7am-7pm. After hours: leave callback."
        )

    def _setup_functions(self):
        @self.tool(description="List available departments")
        def list_departments(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            dept_info = [
                f"{name}: {info['description']}"
                for name, info in self.DEPARTMENTS.items()
            ]
            return SwaigFunctionResult(
                "Available departments: " + "; ".join(dept_info)
            )

        @self.tool(
            description="Route to department",
            parameters={
                "type": "object",
                "properties": {
                    "department": {
                        "type": "string",
                        "enum": list(self.DEPARTMENTS.keys())
                    }
                },
                "required": ["department"]
            }
        )
        def route_to_department(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            department = args.get("department", "")
            dept_info = self.DEPARTMENTS.get(department)
            if not dept_info:
                return SwaigFunctionResult(
                    f"Unknown department. Available: {', '.join(self.DEPARTMENTS.keys())}"
                )

            return (
                SwaigFunctionResult(f"Connecting you to {department} services.")
                .add_action("transfer", {"dest": dept_info["route"]})
            )

        @self.tool(description="Get general information")
        def get_info(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            topic = args.get("topic", "")
            info = {
                "hours": "We're open Mon-Fri 8am-8pm for members, 7am-7pm for providers.",
                "website": "Visit healthfirst.com for online services.",
                "emergency": "For medical emergencies, hang up and call 911."
            }
            return SwaigFunctionResult(
                info.get(topic.lower(), "How can I help direct your call?")
            )


if __name__ == "__main__":
    agent = GatewayAgent()
    agent.run()
```

---

## Validation Checklist

- [ ] Architecture diagram completed
- [ ] Three ADRs documented
- [ ] At least 5 anti-patterns identified
- [ ] Gateway agent implements proper patterns
- [ ] Environment variables used for secrets
- [ ] Prompts are concise and focused

---

## Presentation (Optional)

Prepare a 5-minute presentation covering:

1. Your architecture decisions
2. Key tradeoffs
3. How you addressed HIPAA requirements
4. Lessons from anti-pattern analysis

---

## Submission

Submit:

1. `architecture_design.md`
2. `adr/` directory with ADR files
3. `anti_patterns.md`
4. `gateway_agent.py`
