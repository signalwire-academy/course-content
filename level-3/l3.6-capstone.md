---
layout: default
title: "Lab 3.6: Capstone Project"
parent: "Level 3: Advanced"
nav_order: 26
---
<p style="background: #dff0d8; border: 1px solid #3c763d; border-radius: 4px; padding: 15px; margin: 20px 0;">
<strong>ðŸŽ“ Ready to start this lab?</strong><br>
<a href="https://classroom.github.com/a/HVQwJdIF" target="_blank"><strong>Accept this assignment on GitHub Classroom</strong></a> to get your own repository.
</p>


**Duration:** 4 hours (can be split across sessions)
**Prerequisites:** All Level 3 modules completed
**SDK Version:** signalwire-agents >= 1.0.11

## Overview

Design and implement a production-ready voice AI system that demonstrates mastery of all concepts from the certification program.

---

## Project Options

Choose one of the following capstone projects:

### Option A: Healthcare Appointment System

Build a complete healthcare appointment scheduling system with:

- Patient verification (HIPAA-compliant)
- Appointment scheduling, rescheduling, cancellation
- Insurance eligibility check (DataMap)
- Prescription refill requests
- Multi-department routing

### Option B: Financial Services Platform

Build a banking/financial services voice system with:

- Multi-factor authentication
- Account balance and transaction history
- Bill payment processing (PCI-compliant)
- Loan status inquiries
- Fraud alert handling
- Specialist transfers

### Option C: E-Commerce Customer Service

Build a complete e-commerce support system with:

- Order status and tracking (DataMap)
- Returns and refunds processing
- Product recommendations (knowledge base)
- Inventory inquiries
- Escalation workflows
- Post-call surveys

---

## Requirements

All projects must include:

### 1. Architecture (15 points)

- [ ] Multi-agent design with clear separation of concerns
- [ ] Gateway router for call routing
- [ ] At least 3 specialized agents
- [ ] Architecture documentation with diagrams
- [ ] ADRs for key decisions

### 2. Functionality (25 points)

- [ ] At least 10 SWAIG functions total
- [ ] Multi-step workflows using contexts
- [ ] DataMap integration for external APIs
- [ ] State management across function calls
- [ ] Proper error handling and fallbacks

### 3. Security (20 points)

- [ ] Caller verification/authentication
- [ ] Secure handling of sensitive data
- [ ] Recording pause for PII/PCI data
- [ ] Input validation
- [ ] Security logging

### 4. Observability (15 points)

- [ ] Structured JSON logging
- [ ] Prometheus metrics
- [ ] Health check endpoints
- [ ] Alert configuration

### 5. Performance (10 points)

- [ ] Timeouts on external calls
- [ ] Caching where appropriate
- [ ] Fillers for slow operations
- [ ] Optimized prompts

### 6. Deployment (10 points)

- [ ] Dockerfile
- [ ] docker-compose.yml
- [ ] Environment configuration
- [ ] Health checks

### 7. Documentation (5 points)

- [ ] README with setup instructions
- [ ] API documentation
- [ ] Architecture diagrams

---

## Deliverables

### Directory Structure

```diagram
capstone/
â”œâ”€â”€ README.md
â”œâ”€â”€ architecture/
â”‚   â”œâ”€â”€ overview.md
â”‚   â”œâ”€â”€ diagrams/
â”‚   â”‚   â””â”€â”€ system-architecture.png
â”‚   â””â”€â”€ adr/
â”‚       â”œâ”€â”€ 001-multi-agent-structure.md
â”‚       â”œâ”€â”€ 002-authentication-approach.md
â”‚       â””â”€â”€ 003-state-management.md
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ gateway_agent.py
â”‚   â”œâ”€â”€ [specialized_agent_1].py
â”‚   â”œâ”€â”€ [specialized_agent_2].py
â”‚   â””â”€â”€ [specialized_agent_3].py
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ auth.py
â”‚   â”œâ”€â”€ logging_config.py
â”‚   â””â”€â”€ metrics.py
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ alerts.yml
â”‚   â””â”€â”€ grafana_dashboard.json
â”œâ”€â”€ deployment/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .env.example
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_agents.py
â””â”€â”€ docs/
    â”œâ”€â”€ api.md
    â””â”€â”€ security.md
```

---

## Example: E-Commerce System

### Gateway Agent

```python
#!/usr/bin/env python3
"""E-Commerce Gateway Agent."""

import os
from signalwire_agents import AgentBase, SwaigFunctionResult


class GatewayAgent(AgentBase):
    DEPARTMENTS = {
        "orders": "/orders",
        "returns": "/returns",
        "products": "/products"
    }

    def __init__(self):
        super().__init__(name="ecommerce-gateway", route="/")

        self._configure_auth()

        self.prompt_add_section(
            "Role",
            "E-Commerce gateway. Route to orders, returns, or products."
        )

        self.add_language("English", "en-US", "rime.spore")
        self._setup_functions()

    def _configure_auth(self):
        self.set_params({
            "swml_basic_auth_user": os.getenv("AUTH_USER"),
            "swml_basic_auth_password": os.getenv("AUTH_PASSWORD")
        })

    def _setup_functions(self):
        @self.tool(description="Route to department")
        def route(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            department = args.get("department", "")
            if department not in self.DEPARTMENTS:
                return SwaigFunctionResult(
                    f"Available: {', '.join(self.DEPARTMENTS.keys())}"
                )

            return (
                SwaigFunctionResult(f"Connecting to {department}.", post_process=True)
                .swml_transfer(self.DEPARTMENTS[department], "Goodbye!", final=True)
            )
```

### Orders Agent

```python
#!/usr/bin/env python3
"""Orders Agent with full observability."""

import os
import time
from datetime import datetime
from signalwire_agents import AgentBase, SwaigFunctionResult

from shared.logging_config import setup_logging
from shared.metrics import FUNCTION_LATENCY, FUNCTION_CALLS
from shared.auth import verify_customer


class OrdersAgent(AgentBase):
    def __init__(self):
        super().__init__(name="orders-agent", route="/orders")

        self.logger = setup_logging("orders")

        self._configure_prompts()
        self._configure_recording()
        self.add_language("English", "en-US", "rime.spore")

        self._setup_contexts()
        self._setup_functions()
        self._setup_datamaps()

    def _configure_prompts(self):
        self.prompt_add_section(
            "Role",
            "Orders specialist. Help with order status, tracking, and issues."
        )

    def _configure_recording(self):
        self.set_params({
            "record_call": True,
            "record_format": "mp3",
            "record_stereo": True
        })

    def _setup_contexts(self):
        # Define contexts using the SDK's ContextBuilder pattern
        contexts = self.define_contexts()

        # Verification context
        verify = contexts.add_context("verification")
        verify.add_step("verify_step") \
            .set_text("Let me verify your account.") \
            .set_functions(["verify_customer"]) \
            .set_valid_contexts(["orders"])

        # Order lookup context
        orders = contexts.add_context("orders")
        orders.add_step("order_step") \
            .set_text("How can I help with your order?") \
            .set_functions(["get_order_status", "track_shipment", "report_issue"]) \
            .set_valid_contexts(["issue", "verification"])

        # Issue context
        issue = contexts.add_context("issue")
        issue.add_step("issue_step") \
            .set_text("I'm sorry about that. Let me help resolve this.") \
            .set_functions(["create_ticket", "request_refund", "escalate"]) \
            .set_valid_contexts(["orders"])

    def _setup_functions(self):
        @self.tool(description="Verify customer")
        def verify_customer_func(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            email = args.get("email", "")
            start = time.perf_counter()
            raw_data = raw_data or {}
            call_id = raw_data.get("call_id", "unknown")

            try:
                customer = verify_customer(email)
                duration = (time.perf_counter() - start) * 1000

                FUNCTION_CALLS.labels(
                    agent="orders",
                    function="verify_customer",
                    status="success"
                ).inc()

                return (
                    SwaigFunctionResult(f"Hello {customer['name']}!")
                    .swml_change_context("orders")
                    .set_metadata({
                        "verified": True,
                        "customer_id": customer["id"],
                        "customer_name": customer["name"]
                    })
                )

            except Exception as e:
                self.logger.error(f"Verification failed: {e}")
                return SwaigFunctionResult(
                    "I couldn't verify that account."
                )

        @self.tool(
            description="Get order status",
            fillers=["Looking up your order..."]
        )
        def get_order_status(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            order_id = args.get("order_id", "")
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})

            if not global_data.get("verified"):
                return SwaigFunctionResult(
                    "Please verify your account first."
                )

            # Status would come from DataMap
            return SwaigFunctionResult(
                f"Order {order_id}: Shipped, arriving Thursday."
            )

        @self.tool(description="Report an issue")
        def report_issue(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            order_id = args.get("order_id", "")
            issue = args.get("issue", "")
            return (
                SwaigFunctionResult(
                    "I'm sorry to hear that. Let me help resolve this."
                )
                .swml_change_context("issue")
                .set_metadata({
                    "issue_order": order_id,
                    "issue_description": issue
                })
            )

        @self.tool(description="Create support ticket")
        def create_ticket(args: dict, raw_data: dict = None) -> SwaigFunctionResult:
            priority = args.get("priority", "medium")
            raw_data = raw_data or {}
            global_data = raw_data.get("global_data", {})
            ticket_id = f"TKT-{datetime.now().strftime('%Y%m%d%H%M%S')}"

            return (
                SwaigFunctionResult(
                    f"Created ticket {ticket_id}. "
                    "We'll contact you within 24 hours."
                )
                .set_metadata({"ticket_id": ticket_id})
            )

    def _setup_datamaps(self):
        from signalwire_agents import DataMap, SwaigFunctionResult

        # Real-time order status
        lookup_order = (
            DataMap("lookup_order")
            .description("Get real-time order status")
            .parameter("order_id", "string", "Order ID", required=True)
            .webhook("GET", "https://api.example.com/orders/${enc:args.order_id}")
            .output(SwaigFunctionResult(
                "Order ${response.order_id}: ${response.status}. ${response.details}"
            ))
            .fallback_output(SwaigFunctionResult("Order not found."))
        )
        self.register_swaig_function(lookup_order.to_swaig_function())
```

---

## Evaluation Rubric

| Category | Points | Criteria |
|----------|--------|----------|
| Architecture | 15 | Clear design, proper separation, documented decisions |
| Functionality | 25 | All features work, proper workflows, error handling |
| Security | 20 | Auth, data protection, logging, input validation |
| Observability | 15 | Logging, metrics, alerts, health checks |
| Performance | 10 | Timeouts, caching, optimization |
| Deployment | 10 | Docker, compose, configuration |
| Documentation | 5 | Clear, complete, accurate |

**Total: 100 points**

**Passing Score: 80 points**

---

## Presentation (Optional)

Prepare a 15-minute presentation covering:

1. **Architecture Overview** (3 min)
   - System diagram
   - Agent responsibilities
   - Key design decisions

2. **Feature Demo** (5 min)
   - Walk through main user flows
   - Show key functions working

3. **Technical Deep Dive** (5 min)
   - Security implementation
   - Observability setup
   - Performance optimizations

4. **Q&A** (2 min)

---

## Submission

1. Zip your complete project directory
2. Include README with setup instructions
3. Provide sample `.env.example`
4. Submit via course portal
5. Be prepared for code review

---

## Timeline Suggestion

| Phase | Duration | Activities |
|-------|----------|------------|
| Planning | 30 min | Choose project, design architecture |
| Implementation | 2.5 hours | Build agents, functions, integrations |
| Testing | 30 min | Test all flows, fix issues |
| Documentation | 30 min | Write README, document decisions |

---

Good luck! This capstone demonstrates your readiness to build production voice AI systems.

---

## Complete Agent Code

<details markdown="1">
<summary>Click to reveal complete solution</summary>

```python
#!/usr/bin/env python3
"""Main entry point for enterprise contact center.

Capstone Deliverable: Multi-agent server setup.
"""

import os
from datetime import datetime
from signalwire_agents import AgentServer

from agents.gateway_agent import GatewayAgent
from agents.orders_agent import OrdersAgent
from agents.support_agent import SupportAgent
from shared.logging_config import get_logger
from shared.metrics import start_metrics_server

logger = get_logger("main")


def create_server():
    """Create multi-agent server with health endpoints."""
    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "3000"))
    metrics_port = int(os.getenv("METRICS_PORT", "9090"))

    logger.info(f"Starting server on {host}:{port}")

    # Start metrics server
    if start_metrics_server(metrics_port):
        logger.info(f"Metrics server on port {metrics_port}")

    # Create server and register agents
    server = AgentServer(host=host, port=port)
    server.register(GatewayAgent())
    server.register(OrdersAgent())
    server.register(SupportAgent())

    # Health endpoint
    @server.app.get("/health")
    async def health():
        return {
            "status": "healthy",
            "timestamp": datetime.utcnow().isoformat(),
            "agents": ["gateway", "orders", "support"],
            "version": os.getenv("APP_VERSION", "1.0.0")
        }

    @server.app.get("/ready")
    async def ready():
        return {"ready": True}

    logger.info("All agents registered")
    return server


if __name__ == "__main__":
    server = create_server()
    server.run()
```

</details>
